<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuizMaster ‚Äî Aplikasi Kuis Online</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, getDocs, getDoc,
    setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ======================================================
  // üî• KONFIGURASI FIREBASE
  // Ganti dengan config Firebase project kamu sendiri!
  // Cara mendapatkan: https://console.firebase.google.com
  // 1. Buat project baru
  // 2. Tambahkan Web App
  // 3. Copy firebaseConfig di bawah ini
  // ======================================================
  const firebaseConfig = {
    apiKey: "AIzaSyDEMO_GANTI_DENGAN_API_KEY_KAMU",
    authDomain: "quizmaster-demo.firebaseapp.com",
    projectId: "quizmaster-demo",
    storageBucket: "quizmaster-demo.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef123456"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Expose ke global agar bisa dipakai oleh script non-module
  window._db = db;
  window._firebase = {
    collection, doc, getDocs, getDoc,
    setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp
  };
  window._firebaseReady = true;
  document.dispatchEvent(new Event('firebase-ready'));
</script>

<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <p class="muted">Memuat data...</p>
</div>

<!-- ========== LOGIN ========== -->
<div class="page active" id="page-login">
  <div class="card">
    <div class="logo">
      <div class="logo-icon">Q</div>
      <div class="logo-text">QuizMaster</div>
    </div>
    <h2 style="margin-bottom:6px;">Selamat Datang</h2>
    <p class="muted" style="margin-bottom:28px;">Masuk ke akun kamu untuk melanjutkan</p>

    <div class="tabs">
      <button class="tab active" onclick="switchLoginTab('siswa')">Siswa</button>
      <button class="tab" onclick="switchLoginTab('guru')">Guru</button>
    </div>

    <div id="firebase-config-warn" class="firebase-warn" style="display:none;">
      <strong>‚ö†Ô∏è Firebase belum dikonfigurasi!</strong>
      Buka file HTML ini dan ganti <code>firebaseConfig</code> dengan config project Firebase kamu. Mode demo aktif (data tersimpan lokal saja).
    </div>

    <div class="form-group">
      <label>Username</label>
      <input type="text" id="login-username" placeholder="Masukkan username...">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Masukkan password...">
    </div>
    <p class="muted" style="font-size:0.8rem;margin-bottom:20px;" id="login-hint">
      Demo siswa: <strong>siswa1 / 1234</strong> &nbsp;|&nbsp; <strong>siswa2 / 1234</strong>
    </p>
    <button class="btn btn-primary btn-full" onclick="doLogin()">Masuk ‚Üí</button>
  </div>
</div>

<!-- ========== GURU DASHBOARD ========== -->
<div class="page" id="page-guru">
  <div class="navbar">
    <div class="nav-logo">
      <div class="logo-icon">Q</div>
      <div class="logo-text">QuizMaster</div>
    </div>
    <div class="nav-right">
      <span class="nav-badge">Guru</span>
      <span class="nav-user" id="guru-name-nav"></span>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Keluar</button>
    </div>
  </div>
  <div class="with-navbar">
    <div class="main-content">

      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-num" id="stat-total-kuis">0</div>
          <div class="stat-label">Total Kuis</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="stat-total-soal">0</div>
          <div class="stat-label">Total Soal</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="stat-pengerjaan">0</div>
          <div class="stat-label">Total Pengerjaan</div>
        </div>
      </div>

      <div class="section-header">
        <h2>Daftar Kuis</h2>
        <button class="btn btn-primary" onclick="openModalBuatKuis()">+ Buat Kuis Baru</button>
      </div>
      <div class="quiz-list" id="guru-quiz-list">
        <div class="empty-state"><div class="icon">üìã</div><p>Memuat kuis...</p></div>
      </div>

      <hr class="divider">

      <!-- SISWA YANG TELAH SELESAI - BAGIAN UTAMA -->
      <div class="section-header">
        <div>
          <h2>Siswa Telah Selesai</h2>
          <p class="muted" style="margin-top:4px;">Update real-time ¬∑ <span id="last-update">‚Äî</span></p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="filter-kuis" style="width:auto;padding:8px 12px;font-size:0.85rem;" onchange="filterRiwayat()">
            <option value="">Semua Kuis</option>
          </select>
          <button class="btn btn-secondary btn-sm" onclick="refreshRiwayat()">‚Üª Refresh</button>
        </div>
      </div>
      <div id="selesai-list" class="quiz-list"></div>

      <hr class="divider">

      <div class="section-header">
        <h2>Riwayat Lengkap</h2>
      </div>
      <div class="card full" style="padding:0;overflow:hidden;">
        <table class="history-table">
          <thead><tr>
            <th>Siswa</th><th>Kuis</th><th>Nilai</th><th>Benar</th><th>Salah</th><th>Waktu Selesai</th>
          </tr></thead>
          <tbody id="riwayat-guru-body">
            <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">Memuat...</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- ========== SISWA DASHBOARD ========== -->
<div class="page" id="page-siswa">
  <div class="navbar">
    <div class="nav-logo">
      <div class="logo-icon">Q</div>
      <div class="logo-text">QuizMaster</div>
    </div>
    <div class="nav-right">
      <span class="nav-badge" style="background:var(--accent2);">Siswa</span>
      <span class="nav-user" id="siswa-name-nav"></span>
      <button class="btn btn-secondary btn-sm" onclick="logout()">Keluar</button>
    </div>
  </div>
  <div class="with-navbar">
    <div class="main-content">
      <h2 style="margin-bottom:24px;">Pilih Kuis</h2>
      <div class="quiz-list" id="siswa-quiz-list">
        <div class="empty-state"><div class="icon">üìã</div><p>Memuat kuis...</p></div>
      </div>

      <hr class="divider">
      <h2 style="margin-bottom:16px;">Riwayat Kuis Saya</h2>
      <div class="card full" style="padding:0;overflow:hidden;">
        <table class="history-table">
          <thead><tr>
            <th>Kuis</th><th>Nilai</th><th>Benar</th><th>Salah</th><th>Tanggal</th>
          </tr></thead>
          <tbody id="riwayat-siswa-body">
            <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:24px;">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ========== KUIS PLAYER ========== -->
<div class="page" id="page-kuis">
  <div class="navbar">
    <div class="nav-logo">
      <div class="logo-icon">Q</div>
      <div class="logo-text">QuizMaster</div>
    </div>
    <div class="nav-right">
      <div class="timer-box" id="timer-display">‚è± 00:00</div>
    </div>
  </div>
  <div class="with-navbar">
    <div class="main-content" style="max-width:680px;">
      <div class="quiz-header">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <h3 id="kuis-title-player"></h3>
          <span class="muted" id="soal-counter"></span>
        </div>
        <div class="progress-wrap"><div class="progress-bar" id="progress-bar" style="width:0%"></div></div>
      </div>
      <div class="question-card">
        <div class="question-text" id="question-text"></div>
        <div class="options-list" id="options-list"></div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span class="muted" id="soal-info-text"></span>
        <button class="btn btn-primary" id="btn-next" onclick="nextSoal()" style="display:none;">Lanjut ‚Üí</button>
        <button class="btn btn-success" id="btn-selesai" onclick="selesaiKuis()" style="display:none;">Selesai ‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== HASIL ========== -->
<div class="page" id="page-hasil">
  <div class="navbar">
    <div class="nav-logo">
      <div class="logo-icon">Q</div>
      <div class="logo-text">QuizMaster</div>
    </div>
    <div class="nav-right">
      <button class="btn btn-secondary btn-sm" onclick="showPage('page-siswa');loadSiswaDashboard()">‚Üê Kembali</button>
    </div>
  </div>
  <div class="with-navbar">
    <div class="main-content" style="max-width:640px;">
      <div style="text-align:center;margin-bottom:32px;">
        <p class="label">Kuis Selesai!</p>
        <h1 id="hasil-kuis-title" style="margin-bottom:20px;"></h1>
        <div class="score-circle">
          <div class="score-num" id="hasil-score"></div>
          <div class="score-label">NILAI</div>
        </div>
        <div id="hasil-predikat" style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;margin-bottom:28px;"></div>
      </div>
      <div class="result-grid">
        <div class="result-stat"><div class="num" id="hasil-benar" style="color:var(--accent3)"></div><div class="lbl">Benar</div></div>
        <div class="result-stat"><div class="num" id="hasil-salah" style="color:var(--danger)"></div><div class="lbl">Salah</div></div>
        <div class="result-stat"><div class="num" id="hasil-total"></div><div class="lbl">Total Soal</div></div>
      </div>
      <h3 style="margin-bottom:16px;">Review Jawaban</h3>
      <div id="review-list"></div>
    </div>
  </div>
</div>

<!-- MODAL BUAT/EDIT KUIS -->
<div class="modal-overlay" id="modal-kuis">
  <div class="modal">
    <h2 id="modal-title">Buat Kuis Baru</h2>
    <div class="form-group">
      <label>Judul Kuis</label>
      <input type="text" id="kuis-judul" placeholder="Contoh: Ulangan Harian Matematika BAB 1">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group">
        <label>Durasi (menit)</label>
        <input type="number" id="kuis-durasi" value="10" min="1" max="120">
      </div>
      <div class="form-group">
        <label>Mata Pelajaran</label>
        <input type="text" id="kuis-mapel" placeholder="Matematika">
      </div>
    </div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;margin-top:8px;">
      <h3>Daftar Soal</h3>
      <button class="btn btn-secondary btn-sm" onclick="addSoal()">+ Tambah Soal</button>
    </div>
    <div id="soal-container"></div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;">
      <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
      <button class="btn btn-primary" id="btn-simpan-kuis" onclick="simpanKuis()">Simpan Kuis</button>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal-overlay" id="modal-delete">
  <div class="modal" style="max-width:400px;text-align:center;">
    <div style="font-size:3rem;margin-bottom:16px;">üóëÔ∏è</div>
    <h2 style="margin-bottom:12px;">Hapus Kuis?</h2>
    <p class="muted" style="margin-bottom:28px;">Tindakan ini tidak dapat dibatalkan. Semua soal dan riwayat kuis ini akan terhapus.</p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button class="btn btn-secondary" onclick="closeModalDelete()">Batal</button>
      <button class="btn btn-danger" id="btn-confirm-delete">Hapus</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// USERS (hardcoded ‚Äî bisa diganti dengan auth Firebase)
// ============================================================
const USERS = {
  guru: [
    { username: 'guru1', password: 'guru123', nama: 'Pak Budi' },
    { username: 'guru2', password: 'guru123', nama: 'Bu Sari' }
  ],
  siswa: [
    { username: 'siswa1', password: '1234', nama: 'Andi Pratama' },
    { username: 'siswa2', password: '1234', nama: 'Siti Rahayu' },
    { username: 'siswa3', password: '1234', nama: 'Budi Santoso' }
  ]
};

// ============================================================
// STATE
// ============================================================
let currentUser = null;
let currentRole = null;
let loginTab = 'siswa';
let editKuisId = null;
let deleteKuisId = null;
let soalList = [];
let allKuis = [];
let allRiwayat = [];
let riwayatUnsubscribe = null;

// Kuis player
let playerKuis = null;
let playerSoalIdx = 0;
let playerJawaban = [];
let playerTimer = null;
let playerSisaDetik = 0;
let playerAnswered = false;

// Firebase mode flag
let useFirebase = false;

// ============================================================
// FIREBASE INIT
// ============================================================
document.addEventListener('firebase-ready', async () => {
  try {
    // Test koneksi Firebase
    const db = window._db;
    const { collection, getDocs } = window._firebase;
    await getDocs(collection(db, 'kuis'));
    useFirebase = true;
    console.log('‚úÖ Firebase terhubung');
  } catch (e) {
    useFirebase = false;
    console.warn('‚ö†Ô∏è Firebase gagal, mode lokal aktif:', e.message);
    document.getElementById('firebase-config-warn').style.display = 'block';
    // Load demo data ke localStorage jika kosong
    initLocalData();
  }
});

// Jika Firebase tidak load dalam 3 detik, pakai mode lokal
setTimeout(() => {
  if (!window._firebaseReady) {
    useFirebase = false;
    document.getElementById('firebase-config-warn').style.display = 'block';
    initLocalData();
  }
}, 3000);

// ============================================================
// LOCAL FALLBACK DATA
// ============================================================
function initLocalData() {
  if (!localStorage.getItem('qm_kuis')) {
    localStorage.setItem('qm_kuis', JSON.stringify([
      {
        id: 'k1', judul: 'Ulangan Matematika Bab 1', mapel: 'Matematika', durasi: 10,
        soal: [
          { pertanyaan: 'Berapa hasil dari 7 √ó 8?', opsi: ['48','54','56','60'], jawaban: 2 },
          { pertanyaan: 'Berapakah nilai dari 2¬≥?', opsi: ['4','6','8','12'], jawaban: 2 },
          { pertanyaan: 'Jika x + 5 = 12, maka x = ?', opsi: ['5','6','7','8'], jawaban: 2 },
        ]
      },
      {
        id: 'k2', judul: 'Kuis IPA ‚Äî Tata Surya', mapel: 'IPA', durasi: 8,
        soal: [
          { pertanyaan: 'Planet terbesar di tata surya adalah?', opsi: ['Bumi','Saturnus','Jupiter','Uranus'], jawaban: 2 },
          { pertanyaan: 'Benda langit yang mengelilingi planet disebut?', opsi: ['Bintang','Satelit','Komet','Asteroid'], jawaban: 1 },
        ]
      }
    ]));
  }
  if (!localStorage.getItem('qm_riwayat')) {
    localStorage.setItem('qm_riwayat', JSON.stringify([]));
  }
}

// ============================================================
// UTILS
// ============================================================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

function showLoading(show) {
  document.getElementById('loading-overlay').classList.toggle('active', show);
}

function showNotif(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `notif ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

function genId() { return 'k' + Date.now() + Math.random().toString(36).slice(2,6); }

function formatDate(ts) {
  if (!ts) return '‚Äî';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' })
       + ' ' + d.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function getInitial(nama) {
  return nama ? nama.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2) : '?';
}

// ============================================================
// LOGIN
// ============================================================
function switchLoginTab(tab) {
  loginTab = tab;
  document.querySelectorAll('.tab').forEach((t, i) =>
    t.classList.toggle('active', (i===0 && tab==='siswa') || (i===1 && tab==='guru'))
  );
  const hint = document.getElementById('login-hint');
  hint.innerHTML = tab === 'siswa'
    ? 'Demo siswa: <strong>siswa1 / 1234</strong> &nbsp;|&nbsp; <strong>siswa2 / 1234</strong>'
    : 'Demo guru: <strong>guru1 / guru123</strong> &nbsp;|&nbsp; <strong>guru2 / guru123</strong>';
}

function doLogin() {
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value.trim();
  if (!u || !p) { showNotif('Username dan password tidak boleh kosong!', 'error'); return; }

  const found = USERS[loginTab].find(x => x.username === u && x.password === p);
  if (!found) { showNotif('Username atau password salah!', 'error'); return; }

  currentUser = found;
  currentRole = loginTab;

  if (loginTab === 'guru') {
    document.getElementById('guru-name-nav').textContent = found.nama;
    showPage('page-guru');
    loadGuruDashboard();
  } else {
    document.getElementById('siswa-name-nav').textContent = found.nama;
    showPage('page-siswa');
    loadSiswaDashboard();
  }
  showNotif(`Selamat datang, ${found.nama}! üëã`);
}

function logout() {
  if (riwayatUnsubscribe) { riwayatUnsubscribe(); riwayatUnsubscribe = null; }
  if (playerTimer) clearInterval(playerTimer);
  currentUser = null; currentRole = null;
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  showPage('page-login');
}

// ============================================================
// DATA LAYER ‚Äî abstraksi Firebase / localStorage
// ============================================================
async function dbGetKuis() {
  if (useFirebase) {
    const { collection, getDocs, query, orderBy } = window._firebase;
    const snap = await getDocs(collection(window._db, 'kuis'));
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } else {
    return JSON.parse(localStorage.getItem('qm_kuis') || '[]');
  }
}

async function dbSaveKuis(kuis) {
  if (useFirebase) {
    const { doc, setDoc } = window._firebase;
    await setDoc(doc(window._db, 'kuis', kuis.id), kuis);
  } else {
    const list = JSON.parse(localStorage.getItem('qm_kuis') || '[]');
    const idx = list.findIndex(k => k.id === kuis.id);
    if (idx >= 0) list[idx] = kuis; else list.push(kuis);
    localStorage.setItem('qm_kuis', JSON.stringify(list));
  }
}

async function dbDeleteKuis(id) {
  if (useFirebase) {
    const { doc, deleteDoc, collection, getDocs, query } = window._firebase;
    await deleteDoc(doc(window._db, 'kuis', id));
    // Hapus riwayat terkait
    const snap = await getDocs(collection(window._db, 'riwayat'));
    const batch = snap.docs.filter(d => d.data().kuisId === id);
    for (const d of batch) await deleteDoc(doc(window._db, 'riwayat', d.id));
  } else {
    let list = JSON.parse(localStorage.getItem('qm_kuis') || '[]');
    list = list.filter(k => k.id !== id);
    localStorage.setItem('qm_kuis', JSON.stringify(list));
    let riwayat = JSON.parse(localStorage.getItem('qm_riwayat') || '[]');
    riwayat = riwayat.filter(r => r.kuisId !== id);
    localStorage.setItem('qm_riwayat', JSON.stringify(riwayat));
  }
}

async function dbGetRiwayat(kuisId = null) {
  if (useFirebase) {
    const { collection, getDocs, query, orderBy } = window._firebase;
    const snap = await getDocs(query(collection(window._db, 'riwayat'), orderBy('timestamp', 'desc')));
    const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    return kuisId ? all.filter(r => r.kuisId === kuisId) : all;
  } else {
    const all = JSON.parse(localStorage.getItem('qm_riwayat') || '[]').reverse();
    return kuisId ? all.filter(r => r.kuisId === kuisId) : all;
  }
}

async function dbSaveRiwayat(data) {
  if (useFirebase) {
    const { collection, addDoc, serverTimestamp } = window._firebase;
    await addDoc(collection(window._db, 'riwayat'), {
      ...data,
      timestamp: serverTimestamp()
    });
  } else {
    const list = JSON.parse(localStorage.getItem('qm_riwayat') || '[]');
    list.push({ ...data, timestamp: Date.now() });
    localStorage.setItem('qm_riwayat', JSON.stringify(list));
  }
}

// Subscribe real-time riwayat (hanya Firebase)
function subscribeRiwayat(callback) {
  if (useFirebase) {
    const { collection, onSnapshot, query, orderBy } = window._firebase;
    return onSnapshot(
      query(collection(window._db, 'riwayat'), orderBy('timestamp', 'desc')),
      snap => {
        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        callback(data);
      }
    );
  }
  return null;
}

// ============================================================
// GURU DASHBOARD
// ============================================================
async function loadGuruDashboard() {
  showLoading(true);
  try {
    allKuis = await dbGetKuis();
    renderGuruKuisList();
    populateFilterKuis();

    // Subscribe real-time riwayat
    if (riwayatUnsubscribe) riwayatUnsubscribe();
    if (useFirebase) {
      riwayatUnsubscribe = subscribeRiwayat(data => {
        allRiwayat = data;
        renderGuruRiwayat();
        document.getElementById('last-update').textContent = 'Baru saja';
      });
    } else {
      allRiwayat = await dbGetRiwayat();
      renderGuruRiwayat();
    }
  } catch (e) {
    showNotif('Gagal memuat data: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function refreshRiwayat() {
  if (!useFirebase) {
    allRiwayat = await dbGetRiwayat();
    renderGuruRiwayat();
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString('id-ID');
    showNotif('Data diperbarui!');
  } else {
    showNotif('Mode real-time aktif ‚Äî data otomatis update!');
  }
}

function populateFilterKuis() {
  const sel = document.getElementById('filter-kuis');
  sel.innerHTML = '<option value="">Semua Kuis</option>';
  allKuis.forEach(k => {
    sel.innerHTML += `<option value="${k.id}">${k.judul}</option>`;
  });
}

function filterRiwayat() {
  renderGuruRiwayat();
}

function renderGuruKuisList() {
  const totalSoal = allKuis.reduce((a, k) => a + (k.soal||[]).length, 0);
  document.getElementById('stat-total-kuis').textContent = allKuis.length;
  document.getElementById('stat-total-soal').textContent = totalSoal;

  const el = document.getElementById('guru-quiz-list');
  if (allKuis.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><p>Belum ada kuis. Buat kuis pertama!</p></div>';
    return;
  }
  el.innerHTML = allKuis.map(k => `
    <div class="quiz-item">
      <div class="quiz-item-info">
        <h3>${escHtml(k.judul)}</h3>
        <div class="quiz-meta">
          <span class="badge badge-purple">üìö ${escHtml(k.mapel||'Umum')}</span>
          <span class="badge badge-green">‚ùì ${(k.soal||[]).length} soal</span>
          <span class="badge badge-red">‚è± ${k.durasi} menit</span>
        </div>
      </div>
      <div class="quiz-actions">
        <button class="btn btn-secondary btn-sm" onclick="openModalEditKuis('${k.id}')">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDeleteKuis('${k.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function renderGuruRiwayat() {
  const filterKuisId = document.getElementById('filter-kuis').value;
  const filtered = filterKuisId ? allRiwayat.filter(r => r.kuisId === filterKuisId) : allRiwayat;

  document.getElementById('stat-pengerjaan').textContent = allRiwayat.length;

  // Kartu siswa selesai (dikelompokkan per siswa per kuis, ambil terbaru)
  const selesaiEl = document.getElementById('selesai-list');
  if (filtered.length === 0) {
    selesaiEl.innerHTML = '<div class="empty-state"><div class="icon">üëÄ</div><p>Belum ada siswa yang menyelesaikan kuis' + (filterKuisId ? ' ini' : '') + '.</p></div>';
  } else {
    // Unikkan per siswa+kuis (ambil nilai terbaru)
    const seen = new Map();
    filtered.forEach(r => {
      const key = r.username + '_' + r.kuisId;
      if (!seen.has(key)) seen.set(key, r);
    });
    const unik = [...seen.values()];

    selesaiEl.innerHTML = unik.map(r => {
      const nilaiColor = r.nilai >= 70 ? 'var(--accent3)' : r.nilai >= 50 ? 'var(--warning)' : 'var(--danger)';
      return `
        <div class="selesai-card">
          <div class="selesai-avatar">${getInitial(r.namaSiswa)}</div>
          <div class="selesai-info">
            <div class="selesai-name">${escHtml(r.namaSiswa)}</div>
            <div class="selesai-meta">üìã ${escHtml(r.judulKuis)} &nbsp;¬∑&nbsp; ‚úÖ ${r.benar} benar &nbsp;¬∑&nbsp; ‚ùå ${r.salah} salah &nbsp;¬∑&nbsp; üïê ${formatDate(r.timestamp)}</div>
          </div>
          <div class="selesai-nilai" style="color:${nilaiColor}">${r.nilai}</div>
        </div>
      `;
    }).join('');
  }

  // Tabel riwayat lengkap
  const rb = document.getElementById('riwayat-guru-body');
  if (filtered.length === 0) {
    rb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">Belum ada riwayat</td></tr>';
  } else {
    rb.innerHTML = filtered.map(r => `
      <tr>
        <td><strong>${escHtml(r.namaSiswa)}</strong></td>
        <td>${escHtml(r.judulKuis)}</td>
        <td><strong style="color:${r.nilai>=70?'var(--accent3)':'var(--danger)'}">${r.nilai}</strong></td>
        <td style="color:var(--accent3)">${r.benar}</td>
        <td style="color:var(--danger)">${r.salah}</td>
        <td class="muted">${formatDate(r.timestamp)}</td>
      </tr>
    `).join('');
  }
}

// ============================================================
// SISWA DASHBOARD
// ============================================================
async function loadSiswaDashboard() {
  showLoading(true);
  try {
    allKuis = await dbGetKuis();
    renderSiswaKuisList();
    const myRiwayat = await dbGetRiwayat();
    renderSiswaRiwayat(myRiwayat.filter(r => r.username === currentUser.username));
  } catch (e) {
    showNotif('Gagal memuat data: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

function renderSiswaKuisList() {
  const el = document.getElementById('siswa-quiz-list');
  if (allKuis.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="icon">üòä</div><p>Belum ada kuis. Tunggu guru menambahkan kuis!</p></div>';
    return;
  }
  el.innerHTML = allKuis.map(k => `
    <div class="quiz-item">
      <div class="quiz-item-info">
        <h3>${escHtml(k.judul)}</h3>
        <div class="quiz-meta">
          <span class="badge badge-purple">üìö ${escHtml(k.mapel||'Umum')}</span>
          <span class="badge badge-green">‚ùì ${(k.soal||[]).length} soal</span>
          <span class="badge badge-red">‚è± ${k.durasi} menit</span>
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="mulaiKuis('${k.id}')">Mulai Kuis ‚Üí</button>
    </div>
  `).join('');
}

function renderSiswaRiwayat(list) {
  const rb = document.getElementById('riwayat-siswa-body');
  if (list.length === 0) {
    rb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:24px;">Belum ada riwayat kuis</td></tr>';
    return;
  }
  rb.innerHTML = list.map(r => `
    <tr>
      <td>${escHtml(r.judulKuis)}</td>
      <td><strong style="color:${r.nilai>=70?'var(--accent3)':'var(--danger)'}">${r.nilai}</strong></td>
      <td style="color:var(--accent3)">${r.benar}</td>
      <td style="color:var(--danger)">${r.salah}</td>
      <td class="muted">${formatDate(r.timestamp)}</td>
    </tr>
  `).join('');
}

// ============================================================
// MODAL KUIS
// ============================================================
function openModalBuatKuis() {
  editKuisId = null; soalList = [];
  document.getElementById('modal-title').textContent = 'Buat Kuis Baru';
  document.getElementById('kuis-judul').value = '';
  document.getElementById('kuis-durasi').value = '10';
  document.getElementById('kuis-mapel').value = '';
  renderSoalEditor();
  document.getElementById('modal-kuis').classList.add('active');
}

function openModalEditKuis(id) {
  const k = allKuis.find(x => x.id === id);
  if (!k) return;
  editKuisId = id;
  soalList = (k.soal || []).map(s => ({ ...s, opsi: [...s.opsi] }));
  document.getElementById('modal-title').textContent = 'Edit Kuis';
  document.getElementById('kuis-judul').value = k.judul;
  document.getElementById('kuis-durasi').value = k.durasi;
  document.getElementById('kuis-mapel').value = k.mapel || '';
  renderSoalEditor();
  document.getElementById('modal-kuis').classList.add('active');
}

function closeModal() { document.getElementById('modal-kuis').classList.remove('active'); }

function addSoal() {
  soalList.push({ pertanyaan: '', opsi: ['','','',''], jawaban: 0 });
  renderSoalEditor();
}

function deleteSoal(idx) {
  soalList.splice(idx, 1);
  renderSoalEditor();
}

function renderSoalEditor() {
  const container = document.getElementById('soal-container');
  if (soalList.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:24px 0;"><p>Tambahkan soal untuk kuis ini.</p></div>';
    return;
  }
  container.innerHTML = soalList.map((s, i) => `
    <div class="soal-editor">
      <div class="soal-num">Soal ${i+1}</div>
      <button class="delete-soal" onclick="deleteSoal(${i})">‚úï</button>
      <div class="form-group" style="margin-bottom:10px;">
        <input type="text" placeholder="Tulis pertanyaan..." value="${escHtml(s.pertanyaan)}" oninput="soalList[${i}].pertanyaan=this.value">
      </div>
      <p class="label">Pilihan Jawaban (pilih yang benar)</p>
      <div class="options-grid">
        ${s.opsi.map((o, j) => `
          <div class="option-item">
            <input type="radio" name="jawaban-${i}" ${s.jawaban===j?'checked':''} onchange="soalList[${i}].jawaban=${j}">
            <input type="text" placeholder="Opsi ${['A','B','C','D'][j]}" value="${escHtml(o)}" oninput="soalList[${i}].opsi[${j}]=this.value">
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

async function simpanKuis() {
  const judul = document.getElementById('kuis-judul').value.trim();
  const durasi = parseInt(document.getElementById('kuis-durasi').value) || 10;
  const mapel = document.getElementById('kuis-mapel').value.trim();

  if (!judul) { showNotif('Judul kuis tidak boleh kosong!', 'error'); return; }
  if (soalList.length === 0) { showNotif('Tambahkan minimal 1 soal!', 'error'); return; }
  for (let i = 0; i < soalList.length; i++) {
    if (!soalList[i].pertanyaan.trim()) { showNotif(`Pertanyaan soal ${i+1} kosong!`, 'error'); return; }
    if (soalList[i].opsi.some(o => !o.trim())) { showNotif(`Opsi soal ${i+1} belum lengkap!`, 'error'); return; }
  }

  const btn = document.getElementById('btn-simpan-kuis');
  btn.disabled = true; btn.textContent = 'Menyimpan...';

  try {
    const kuisData = {
      id: editKuisId || genId(),
      judul, durasi, mapel, soal: soalList
    };
    await dbSaveKuis(kuisData);
    allKuis = await dbGetKuis();
    renderGuruKuisList();
    populateFilterKuis();
    closeModal();
    showNotif(editKuisId ? 'Kuis berhasil diperbarui! ‚úÖ' : 'Kuis berhasil dibuat! üéâ');
  } catch (e) {
    showNotif('Gagal menyimpan: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Simpan Kuis';
  }
}

// ============================================================
// DELETE KUIS
// ============================================================
function confirmDeleteKuis(id) {
  deleteKuisId = id;
  document.getElementById('modal-delete').classList.add('active');
  document.getElementById('btn-confirm-delete').onclick = async () => {
    try {
      await dbDeleteKuis(deleteKuisId);
      allKuis = await dbGetKuis();
      allRiwayat = await dbGetRiwayat();
      renderGuruKuisList();
      renderGuruRiwayat();
      populateFilterKuis();
      closeModalDelete();
      showNotif('Kuis berhasil dihapus!');
    } catch (e) {
      showNotif('Gagal menghapus: ' + e.message, 'error');
    }
  };
}

function closeModalDelete() { document.getElementById('modal-delete').classList.remove('active'); }

// ============================================================
// KUIS PLAYER
// ============================================================
function mulaiKuis(kuisId) {
  const k = allKuis.find(x => x.id === kuisId);
  if (!k) return;
  if (!k.soal || k.soal.length === 0) { showNotif('Kuis ini belum ada soal!', 'error'); return; }

  playerKuis = k;
  playerSoalIdx = 0;
  playerJawaban = new Array(k.soal.length).fill(null);
  playerSisaDetik = k.durasi * 60;
  playerAnswered = false;

  document.getElementById('kuis-title-player').textContent = k.judul;
  showPage('page-kuis');
  renderSoalPlayer();
  startTimer();
}

function renderSoalPlayer() {
  const s = playerKuis.soal[playerSoalIdx];
  const total = playerKuis.soal.length;
  playerAnswered = false;

  document.getElementById('soal-counter').textContent = `${playerSoalIdx+1} / ${total}`;
  document.getElementById('progress-bar').style.width = `${((playerSoalIdx+1)/total)*100}%`;
  document.getElementById('soal-info-text').textContent = 'Pilih jawaban yang benar';
  document.getElementById('question-text').textContent = s.pertanyaan;

  const letters = ['A','B','C','D'];
  document.getElementById('options-list').innerHTML = s.opsi.map((o, i) => `
    <button class="option-btn ${playerJawaban[playerSoalIdx]===i?'selected':''}" onclick="pilihJawaban(${i})" id="opt-${i}">
      <span class="option-letter">${letters[i]}</span>${escHtml(o)}
    </button>
  `).join('');

  const isLast = playerSoalIdx === total - 1;
  document.getElementById('btn-next').style.display = (!isLast && playerJawaban[playerSoalIdx]!==null) ? '' : 'none';
  document.getElementById('btn-selesai').style.display = (isLast && playerJawaban[playerSoalIdx]!==null) ? '' : 'none';

  if (playerJawaban[playerSoalIdx] !== null) showAnswerFeedback(playerJawaban[playerSoalIdx]);
}

function pilihJawaban(idx) {
  if (playerAnswered) return;
  playerAnswered = true;
  playerJawaban[playerSoalIdx] = idx;
  showAnswerFeedback(idx);
}

function showAnswerFeedback(selected) {
  const s = playerKuis.soal[playerSoalIdx];
  const isLast = playerSoalIdx === playerKuis.soal.length - 1;
  document.querySelectorAll('.option-btn').forEach((btn, i) => {
    btn.onclick = null;
    if (i === s.jawaban) btn.classList.add('correct');
    else if (i === selected && selected !== s.jawaban) btn.classList.add('wrong');
    btn.querySelector('.option-letter').style.background = i===s.jawaban ? 'var(--accent3)' : i===selected ? 'var(--danger)' : '';
  });
  document.getElementById('btn-next').style.display = !isLast ? '' : 'none';
  document.getElementById('btn-selesai').style.display = isLast ? '' : 'none';
  document.getElementById('soal-info-text').textContent =
    selected === s.jawaban ? '‚úÖ Benar!' : `‚ùå Salah! Jawaban: ${['A','B','C','D'][s.jawaban]}`;
}

function nextSoal() {
  if (playerSoalIdx < playerKuis.soal.length - 1) { playerSoalIdx++; renderSoalPlayer(); }
}

function selesaiKuis() { clearInterval(playerTimer); tampilHasil(); }

function startTimer() {
  if (playerTimer) clearInterval(playerTimer);
  updateTimerDisplay();
  playerTimer = setInterval(() => {
    playerSisaDetik--;
    updateTimerDisplay();
    if (playerSisaDetik <= 0) {
      clearInterval(playerTimer);
      showNotif('Waktu habis! Kuis dikumpulkan otomatis.', 'error');
      setTimeout(tampilHasil, 1000);
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(playerSisaDetik/60).toString().padStart(2,'0');
  const s = (playerSisaDetik%60).toString().padStart(2,'0');
  const el = document.getElementById('timer-display');
  el.textContent = `‚è± ${m}:${s}`;
  el.className = 'timer-box' + (playerSisaDetik<=30?' danger':playerSisaDetik<=60?' warning':'');
}

async function tampilHasil() {
  let benar = 0;
  playerKuis.soal.forEach((s, i) => { if (playerJawaban[i] === s.jawaban) benar++; });
  const salah = playerKuis.soal.length - benar;
  const nilai = Math.round((benar / playerKuis.soal.length) * 100);

  // Simpan ke DB
  try {
    await dbSaveRiwayat({
      username: currentUser.username,
      namaSiswa: currentUser.nama,
      kuisId: playerKuis.id,
      judulKuis: playerKuis.judul,
      nilai, benar, salah
    });
  } catch (e) {
    console.error('Gagal simpan riwayat:', e);
  }

  // Tampil hasil
  document.getElementById('hasil-kuis-title').textContent = playerKuis.judul;
  document.getElementById('hasil-score').textContent = nilai;
  document.getElementById('hasil-benar').textContent = benar;
  document.getElementById('hasil-salah').textContent = salah;
  document.getElementById('hasil-total').textContent = playerKuis.soal.length;

  const predikat = nilai>=90?'üèÜ Sempurna!':nilai>=80?'üåü Sangat Baik!':nilai>=70?'üëç Baik!':nilai>=60?'üìö Cukup':'üí™ Terus Belajar!';
  document.getElementById('hasil-predikat').textContent = predikat;

  document.getElementById('review-list').innerHTML = playerKuis.soal.map((s, i) => {
    const ok = playerJawaban[i] === s.jawaban;
    return `
      <div class="review-item ${ok?'correct-ans':'wrong-ans'}">
        <p style="font-weight:500;margin-bottom:6px;">${i+1}. ${escHtml(s.pertanyaan)}</p>
        <p class="muted">Jawabanmu: <strong>${playerJawaban[i]!==null ? escHtml(s.opsi[playerJawaban[i]]) : '(tidak dijawab)'}</strong></p>
        ${!ok ? `<p style="color:var(--accent3);font-size:0.85rem;">Jawaban benar: <strong>${escHtml(s.opsi[s.jawaban])}</strong></p>` : ''}
      </div>
    `;
  }).join('');

  showPage('page-hasil');
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.getElementById('modal-kuis').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });
document.getElementById('modal-delete').addEventListener('click', e => { if(e.target===e.currentTarget) closeModalDelete(); });
document.getElementById('login-password').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
</script>
</body>
</html>
